<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/html">
<head>
    <title>마이페이지</title>
    <div th:replace="fragments/header.html :: fragment-header"></div>
</head>
<body>
    <div class="container" style="height: 880px;">
        <section>
            <button type="button" onclick="popupCenter('/selectCurrentPwd', '비밀번호 변경', '500', '280')" class="btn btn-outline-success me-2" style="float: right; font-size: 15px; margin-bottom: 15px;">비밀번호 변경</button>
            <div th:if="${#lists.size(history) != 0}">
                <table class="table table-bordered">
                    <thread>
                        <tr class="pb-3 pt-3">
                            <th scope="col" class="pb-4 pt-4 text-center text-bold">상신일자</th>
                            <th scope="col" class="pb-4 pt-4 text-center text-bold">사번</th>
                            <th scope="col" class="pb-4 pt-4 text-center text-bold">이름</th>
                            <th scope="col" class="pb-4 pt-4 text-center text-bold">사용연차</th>
                            <th scope="col" class="pb-4 pt-4 text-center text-bold">날짜</th>
                            <th scope="col" class="pb-4 pt-4 text-center text-bold">사유</th>
                            <th scope="col" class="pb-4 pt-4 text-center text-bold">담당자</th>
                            <th scope="col" class="pb-4 pt-4 text-center text-bold">결정권자</th>
                            <th scope="col" class="pb-4 pt-4 text-center text-bold">첨부파일</th>
                            <th scope="col" class="pb-4 pt-4 text-center text-bold">비고</th>
                            <th scope="col" class="pb-4 pt-4 text-center text-bold">취소</th>
                        </tr>
                    </thread>
                    <tbody>
                        <tr th:each="list : ${history}">
                            <td scope="row" class="pb-4 pt-4 text-center table-custom">[[${list.request_date}]]</td>
                            <td scope="row" class="pb-4 pt-4 text-center table-custom">[[${list.user_id}]]</td>
                            <td scope="row" class="pb-4 pt-4 text-center table-custom">[[${list.user_name}]]</td>
                            <td scope="row" class="pb-4 pt-4 text-center table-custom">[[${list.application_year}]]일 / [[${list.time}]]</td>
                            <td scope="row" class="pb-4 pt-4 text-center table-custom">[[${list.start_date}]] ~ [[${list.end_date}]]</td>
                            <td scope="row" class="pb-4 pt-4 text-center table-custom">[[${list.reason}]]</td>
                            <td scope="row" class="pb-4 pt-4 text-center table-custom" th:if="${list.appr_yn.equals('Y')}">승인</td>
                            <td scope="row" class="pb-4 pt-4 text-center table-custom" th:if="${list.appr_yn.equals('N')}">미승인</td>
                            <td scope="row" class="pb-4 pt-4 text-center table-custom" th:if="${list.appr_yn2.equals('Y')}">승인</td>
                            <td scope="row" class="pb-4 pt-4 text-center table-custom" th:if="${list.appr_yn2.equals('N')}">미승인</td>
                            <td scope="row" class="pb-4 pt-4 text-center table-custom" style="position: relative;" th:if="${list.file_id != null}">
                                <div class="view_file_box">
                                    <a href="javascript:void(0)" class="btn_link">
                                        <span class="txt">
                                            <p th:title="${list.file_id}">목록보기</p>
                                        </span>
                                    </a>
                                    <div class="link_list" style="display: none; z-index: 1; position: absolute;">
                                        <li th:if="${list.file_id} == ${file.file_id}" th:each="file : ${fileList}" th:id="|file_${file.file_id}|" th:name="${file.file_uuid}" class="fileList">
                                            <a href="javascript:void(0)" style="cursor: default; text-decoration-line: none;">[[${file.origin_file_name}]]</a>
                                        </li>
                                    </div>
                                </div>
                            </td>
                            <td scope="row" class="pb-4 pt-4 text-center table-custom" th:unless="${list.file_id != null}">-</td>
                            <td scope="row" class="pb-4 pt-4 text-center table-custom" th:if="${list.holiday != null}">[[${list.holiday}]]</td>
                            <td scope="row" class="pb-4 pt-4 text-center table-custom" th:unless="${list.holiday != null}">-</td>
                            <td scope="row" class="pb-4 pt-4 text-center table-custom" th:if="${list.appr_yn2.equals('N')}"><a href="javascript:void(0)" style="color: red;" th:name="${list.history_id}" th:onclick="deleteHistory(this)">취소</a></td>
                            <td scope="row" class="pb-4 pt-4 text-center table-custom" th:if="${list.appr_yn2.equals('Y')}"></td>
                        </tr>
                    </tbody>
                </table>

                <nav aria-label="Page navigation example" style="font-size: 16px">
                    <ul class="pagination" style="justify-content: center;">
                        <li class="page-item">
                            <a class="page-link" th:href="@{/myPage?page=1}" aria-label="Previous">
                                <span aria-hidden="true">처음</span>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" th:href="@{/myPage?page={page} (page = ${pagination.prevBlock})}" aria-label="Previous">
                                <span aria-hidden="true">이전</span>
                            </a>
                        </li>
                        <th:block  th:with="start = ${pagination.startPage}, end = ${pagination.endPage}">
                            <li class="page-item"
                                th:with="start = ${pagination.startPage}, end = ${pagination.endPage}"
                                th:each="pageButton : ${#numbers.sequence(start, end)}">
                                <a class="page-link" th:href="@{/myPage?page={page} (page = ${pageButton})}" th:text=${pageButton}
                                   th:style="${pagination.page} == ${pageButton} ? 'background-color: blue; color: white;' : ''"></a>
                            </li>
                        </th:block>
                        <li class="page-item">
                            <a class="page-link" th:href="@{/myPage?page={page} (page = ${pagination.nextBlock})}" aria-label="Next">
                                <span aria-hidden="true">다음</span>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" th:href="@{/myPage?page={page} (page = ${pagination.totalPageCnt})}" aria-label="Previous">
                                <span aria-hidden="true">끝</span>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
            <div th:if="${#lists.size(history) == 0}" style="font-size: 25px; text-align: center;">
                데이터가 없습니다!
            </div>
            <div class="spinner-border loading" role="status">
                <span class="visually-hidden"></span>
            </div>
        </section>
    </div>
<script>
    const deleteHistory = async (id) => {
        if(confirm("삭제하시겠습니까?")) {
            loadingShow();
            await fetch("/deleteHistory/"+id.name, {
                method: "DELETE",
                headers: {
                    'Content-Type': 'application/json'
                },
                body: {
                }
            }).then((response) => {
                if(!response.ok)
                    throw response;
                alert("삭제가 완료되었습니다.");
                window.location.href="/myPage";
            }).catch(e => {
                console.log("에러 발생");
            });
            loadingHide();
        }
    }

    $(document).on('click', '.view_file_box a.btn_link', function() {
        if ($(this).hasClass("active") && document.getElementsByClassName("active").length < 2) {
            $(this).removeClass("active").next().stop(true, true).slideUp(0);
            $(this).siblings().removeClass("activeFile");
        } else {
            $(this).addClass("active").next().stop(true, true).slideDown(700);
            $(this).siblings().addClass("activeFile");
        }

        //다운로드 팝업이 열려있는 상태에서 다른 다운로드 팝업 클릭 시 실행
        if(document.getElementsByClassName("active").length > 1) {
            $("a.active").not($(this)).removeClass("active").next().stop(true, true).slideUp(0);
            $(".link_list").not($(this)).removeClass("activeFile");

            if ($(this).siblings().hasClass("activeFile")) {
                $(this).siblings().removeClass("activeFile");
            } else {
                $(this).siblings().addClass("activeFile");
            }
        }
    });
</script>
</body>
</html>